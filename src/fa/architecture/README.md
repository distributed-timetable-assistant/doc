# **معماری**

پلتفرم DiTA به عنوان مجموعه‌ای از **میکروسرویس‌های بومی کوبرنتیز (Kubernetes-native)** ساخته شده است. این پلتفرم جداسازی واضحی بین مدیریت داده (منابع)، منطق (پردازشگرها) و ابزارهای پلتفرم اعمال می‌کند.

**انعطاف‌پذیری در استقرار:**
*   **میزبانی کامل شخصی (Self-Hosting):** کل پلتفرم می‌تواند برای کنترل کامل به صورت محلی (On-Premise) مستقر شود.
*   **ترکیبی (Hybrid):** استفاده از ابر عمومی برای برخی سرویس‌ها (مانند بازار) در حالی که سرویس‌های منابع حساس به صورت شخصی میزبانی می‌شوند.
*   **سطح سرویس:** سرویس‌های فردی می‌توانند به طور مستقل جایگزین یا میزبانی شوند.

**تکنولوژی‌های کلیدی:**
*   **ارتباطات:** Kafka (گذرگاه رویداد)، gRPC/REST.
*   **وضعیت (State):** PostgreSQL (رابطه‌ای)، Elasticsearch (جستجو/اینکس)، Redis (کش/موقتی).
*   **هویت:** Keycloak.

![نمودار معماری DiTA](../images/architecture.png)

---

## گروه‌های سرویس

### ۱. سرویس‌های منابع (حقیقت)
این سرویس‌ها داده‌های دامنه اصلی را مدیریت می‌کنند. آنها منبع حقیقت سیستم هستند.
*   **`packet-manager`**: بسته‌های ارسالی و چرخه عمر آنها را مدیریت می‌کند. برای جستجوی با کارایی بالا از **Elasticsearch** استفاده می‌کند.
*   **`people`**: پروفایل‌ها (مدرسان، دانشجویان) و در دسترس بودن را مدیریت می‌کند.
*   **`organization`**: ابرداده‌های مدرسه/دانشگاه را مدیریت می‌کند.
*   **`resources`**: دارایی‌های فیزیکی (اتاق‌ها، تجهیزات) را مدیریت می‌کند.
*   **`subjects`**: برنامه درسی و تعاریف موضوعات را مدیریت می‌کند.

### ۲. سرویس‌های پردازشگر (کارگران)
این سرویس‌ها رویدادها را مصرف کرده و کارهای سنگین را انجام می‌دهند.
*   **`basic-scheduler`**: یک حل‌کننده خودکار که جداول زمانی را تولید می‌کند. برای صف‌های کار از **Redis** استفاده می‌کند.
*   **`manual-scheduler`**: از ویرایش توسط انسان (Human-in-the-loop) پشتیبانی می‌کند.
*   **`packet-analyzer`**: ویژگی‌ها (پیچیدگی، محدودیت‌ها) را از بسته‌ها استخراج می‌کند تا حل‌کنندگان را راهنمایی کند.
*   **`timetable-ranker`**: پردازشگر جریانی که راه‌حل‌های ورودی را امتیازدهی می‌کند.

### ۳. پلتفرم و زیرساخت
*   **`wallet`**: اعتبارات و تراکنش‌ها را مدیریت می‌کند (انحصاری ابر).
*   **`notification`**: هشدارها و پیام‌ها را مدیریت می‌کند.
*   **`kafka`**: سیستم عصبی مرکزی. همه سرویس‌ها رویدادهای دامنه را در اینجا منتشر/مشترک می‌شوند.
*   **`ingress`**: مسیریابی و متعادل‌سازی بار را مدیریت می‌کند.

---

## جریان تعامل فنی

سیستم بر یک **معماری رویداد-محور (Event-Driven)** متکی است:

۱.  **ورود داده (Ingestion):** فراخوانی‌های API به سرویس‌های منابع، رویدادهایی (مانند `packet.created`) را به Kafka ارسال می‌کنند.
۲.  **پردازش:** سرویس‌های پردازشگر (مانند `basic-scheduler`) در این تاپیک‌ها مشترک می‌شوند.
۳.  **انتشار نتایج:** پردازشگرها نتایج (مانند `candidate.created`) را دوباره به Kafka منتشر می‌کنند.
۴.  **تجمع (Aggregation):** سرویس‌های تحلیلی (`timetable-ranker`) جریان‌های نتایج را مصرف می‌کنند تا امتیازات را به صورت بلادرنگ به‌روزرسانی کنند.